# üîß –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –ü—Ä–æ–±–ª–µ–º–∞ –∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—î—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–≤—ñ–¥–æ–º–∏–≤ –ø—Ä–æ –Ω–µ—Å–ø—Ä–∞–≤–Ω—ñ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—ó:

**–í–≤–µ–¥–µ–Ω–Ω—è:** `999 –û–±—ñ–¥ –≤ –∑–∞–∫–ª–∞–¥—ñ ILoveKebab`

**–û—á—ñ–∫—É–≤–∞–Ω–æ:**

```
ü§ñ –Ø –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞–≤ –≤–∞—à—É –æ–ø–µ—Ä–∞—Ü—ñ—é:
üí∏ -999‚Ç¥ ‚Ä¢ –û–±—ñ–¥ –≤ –∑–∞–∫–ª–∞–¥—ñ ILoveKebab
üìç –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–Ω–µ—Å–µ–Ω–æ –¥–æ: üçΩÔ∏è –ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏
```

**–§–∞–∫—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:**

```
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –¥–æ–¥–∞–Ω–æ!
üí∏ 999‚Ç¥ ‚Ä¢ –û–±—ñ–¥ –≤ –∑–∞–∫–ª–∞–¥—ñ ILoveKebab
üìÇ üè† –ñ–∏—Ç–ª–æ  ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê –ö–ê–¢–ï–ì–û–†–Ü–Ø!
```

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

**–ö–æ—Ä–µ–Ω–µ–≤–∞ –ø—Ä–∏—á–∏–Ω–∞:** –°–∏—Å—Ç–µ–º–∞ ML –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–≤–µ—Ä—Ç–∞–ª–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ ID (1, 2, 3...), –∞–ª–µ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–ª–∏ —ñ–Ω—à—ñ —Ä–µ–∞–ª—å–Ω—ñ ID –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.

**–ü–æ—Ç–æ–∫ –ø–æ–º–∏–ª–∫–∏:**

1. ML —Å–∏—Å—Ç–µ–º–∞: "–æ–±—ñ–¥" ‚Üí –∫–∞—Ç–µ–≥–æ—Ä—ñ—è "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" –∑ ID=3
2. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –ë–î: —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑ category_id=3
3. –£ –ë–î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ID=3 –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "–ñ–∏—Ç–ª–æ"
4. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è `perform_auto_categorization()`

**–î–æ–¥–∞–Ω–æ –ª–æ–≥—ñ–∫—É –ø–æ—à—É–∫—É —ñ—Å–Ω—É—é—á–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:**

```python
# –®—É–∫–∞—î–º–æ —ñ—Å–Ω—É—é—á—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –Ω–∞–∑–≤–æ—é
user_categories = get_user_categories(user.id, category_type=transaction_data['type'])
real_category = None

# –ü–æ—à—É–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑–∞ –Ω–∞–∑–≤–æ—é
for category in user_categories:
    if category.name.lower() == suggested_category['name'].lower():
        real_category = {
            'id': category.id,  # –†–ï–ê–õ–¨–ù–ò–ô ID –∑ –ë–î
            'name': category.name,
            'icon': category.icon or suggested_category['icon']
        }
        break
```

**–î–æ–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:**

```python
# –Ø–∫—â–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É
if not real_category:
    new_category = create_category(
        user_id=user.id,
        category_name=suggested_category['name'],
        category_type=db_type,
        icon=suggested_category['icon']
    )
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ù–û–í–ò–ô —Ä–µ–∞–ª—å–Ω–∏–π ID
    real_category = {'id': new_category.id, ...}
```

### 2. Fallback –ª–æ–≥—ñ–∫–∞

```python
# –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–∏–π—à–ª–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–µ—Ä—à—É –¥–æ—Å—Ç—É–ø–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
if user_categories:
    first_category = user_categories[0]
    real_category = {
        'id': first_category.id,  # –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∏–π —Ä–µ–∞–ª—å–Ω–∏–π ID
        'name': first_category.name,
        'icon': first_category.icon or 'üì¶'
    }
```

### 3. –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è

```python
logger.info(f"Saving transaction: user_id={user.id}, category_id={category_id}")
logger.info(f"Retrieved category: id={category.id}, name={category.name}")
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

**–¢–µ—Å—Ç-–∫–µ–π—Å:** `999 –û–±—ñ–¥ –≤ –∑–∞–∫–ª–∞–¥—ñ ILoveKebab`

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ö–∞—Ç–µ–≥–æ—Ä—ñ—è "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" —ñ—Å–Ω—É—î

```
üîç –ü–æ—à—É–∫ –≤ –ë–î: "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" ‚Üí –ó–ù–ê–ô–î–ï–ù–û (ID=127)
‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ: category_id=127
üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –≤ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏"
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –ö–∞—Ç–µ–≥–æ—Ä—ñ—è "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" –ù–ï —ñ—Å–Ω—É—î

```
üîç –ü–æ—à—É–∫ –≤ –ë–î: "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" ‚Üí –ù–ï –ó–ù–ê–ô–î–ï–ù–û
‚ûï –°—Ç–≤–æ—Ä–µ–Ω–Ω—è: –Ω–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" (ID=156)
‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ: category_id=156
üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –≤ –Ω–æ–≤—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏"
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

```
üîç –ü–æ—à—É–∫ –≤ –ë–î: "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏" ‚Üí –ù–ï –ó–ù–ê–ô–î–ï–ù–û
‚ûï –°—Ç–≤–æ—Ä–µ–Ω–Ω—è: –ü–û–ú–ò–õ–ö–ê
üîÑ Fallback: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–µ—Ä—à—É –¥–æ—Å—Ç—É–ø–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é (ID=45)
‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ: category_id=45
üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–∞
```

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –¢–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

**–í–≤–µ–¥–µ–Ω–Ω—è:** `999 –û–±—ñ–¥ –≤ –∑–∞–∫–ª–∞–¥—ñ ILoveKebab`

**–°–∏—Å—Ç–µ–º–∞:**

1. ü§ñ ML: "–æ–±—ñ–¥" ‚Üí "–ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏"
2. üîç –ü–æ—à—É–∫ –≤ –ë–î: –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –∞–±–æ —Å—Ç–≤–æ—Ä—é—î –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
3. üíæ –ó–±–µ—Ä—ñ–≥–∞—î –∑ –ü–†–ê–í–ò–õ–¨–ù–ò–ú ID
4. ‚úÖ –ü–æ–∫–∞–∑—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–í–∏–≤—ñ–¥:**

```
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –¥–æ–¥–∞–Ω–æ!
üí∏ 999‚Ç¥ ‚Ä¢ –û–±—ñ–¥ –≤ –∑–∞–∫–ª–∞–¥—ñ ILoveKebab
üìÇ üçΩÔ∏è –ö–∞—Ñ–µ —ñ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∏  ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û!
```

## üîÑ –°—Ç–∞—Ç—É—Å

- ‚úÖ **–ü—Ä–æ–±–ª–µ–º—É –≤–∏—è–≤–ª–µ–Ω–æ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ**
- ‚úÖ **–ö–æ–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó**
- ‚úÖ **–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º–∏**
- ‚úÖ **–î–æ–¥–∞–Ω–æ —Ç–µ—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏**
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è**

### üìù –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏:

- `handlers/transaction_handler.py` - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ `perform_auto_categorization()` —Ç–∞ `save_transaction_to_db()`
- `test_category_fix.py` - –¥–æ–¥–∞–Ω–æ —Ç–µ—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Ç–µ–ø–µ—Ä –º–æ–∂—É—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è —Å–∏—Å—Ç–µ–º–æ—é –±–µ–∑ –ø—Ä–æ–±–ª–µ–º –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—î—é! üéâ
