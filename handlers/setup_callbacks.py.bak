from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler
from database.db_operations import get_user, get_or_create_user, get_user_categories
from database.session import Session
from database.models import User, Category, TransactionType, Transaction
from datetime import datetime

# –°—Ç–∞–Ω–∏ –¥–ª—è ConversationHandler
WAITING_CURRENCY_SELECTION = 1
WAITING_BALANCE_INPUT = 2
SETUP_COMPLETE = 3

async def show_currency_selection(query, context):
    """–ü–æ—á–∏–Ω–∞—î –ø—Ä–æ—Ü–µ—Å –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ - –∫—Ä–æ–∫ 1: –≤–∏–±—ñ—Ä –≤–∞–ª—é—Ç–∏"""
    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    context.user_data['setup_step'] = 'currency'
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∏–±–æ—Ä—É –≤–∞–ª—é—Ç–∏
    keyboard = [
        [
            InlineKeyboardButton("üá∫üá¶ UAH (‚Ç¥)", callback_data="currency_UAH"),
            InlineKeyboardButton("üá∫üá∏ USD ($)", callback_data="currency_USD")
        ],
        [
            InlineKeyboardButton("üá™üá∫ EUR (‚Ç¨)", callback_data="currency_EUR"),
            InlineKeyboardButton("üá¨üáß GBP (¬£)", callback_data="currency_GBP")
        ],
        [
            InlineKeyboardButton("¬´ –°–∫–∞—Å—É–≤–∞—Ç–∏", callback_data="back_to_main")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message_text = (
        "üöÄ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ - –ö—Ä–æ–∫ 1 –∑ 2*\n\n"
        "üí± *–û–±–µ—Ä—ñ—Ç—å –æ—Å–Ω–æ–≤–Ω—É –≤–∞–ª—é—Ç—É*\n\n"
        "–¶—è –≤–∞–ª—é—Ç–∞ –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—å –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É —Ç–∞ –æ–ø–µ—Ä–∞—Ü—ñ–π.\n"
        "–û–±–µ—Ä—ñ—Ç—å –≤–∞–ª—é—Ç—É, –≤ —è–∫—ñ–π –≤–∏ –∑–∞–∑–≤–∏—á–∞–π –≤–µ–¥–µ—Ç–µ –æ–±–ª—ñ–∫ —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤:"
    )
    
    message = await query.edit_message_text(
        message_text, 
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    context.user_data['message_id'] = message.message_id
    
    return WAITING_CURRENCY_SELECTION

async def process_currency_selection(query, context):
    """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –≤–∞–ª—é—Ç–∏"""
    # –û—Ç—Ä–∏–º—É—î–º–æ –≤–∏–±—Ä–∞–Ω—É –≤–∞–ª—é—Ç—É
    currency_code = query.data.split("_")[1]
    user_id = query.from_user.id
    
    with Session() as session:
        user = session.query(User).filter(User.telegram_id == user_id).first()
        user.currency = currency_code
        session.commit()
    
    # –¢–µ–ø–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –∫—Ä–æ–∫—É –≤–≤–µ–¥–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É
    keyboard = [[InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="back_to_currency")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–∏–º–≤–æ–ª –≤–∞–ª—é—Ç–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    currency_symbols = {
        "UAH": "‚Ç¥",
        "USD": "$",
        "EUR": "‚Ç¨",
        "GBP": "¬£"
    }
    currency_symbol = currency_symbols.get(currency_code, currency_code)
    
    message_text = (
        "üöÄ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ - –ö—Ä–æ–∫ 2 –∑ 2*\n\n"
        f"‚úÖ –í–∞–ª—é—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {currency_code} ({currency_symbol})\n\n"
        "üí∞ *–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å*\n\n"
        f"–í–∫–∞–∂—ñ—Ç—å —Å—É–º—É –∫–æ—à—Ç—ñ–≤, —è–∫—É –≤–∏ –º–∞—î—Ç–µ –∑–∞—Ä–∞–∑ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 5000).\n"
        "–¶–µ –¥–æ–ø–æ–º–æ–∂–µ –Ω–∞–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –≤–∞—à—ñ —Ñ—ñ–Ω–∞–Ω—Å–∏.\n\n"
        "–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É –≤ —á–∏—Å–ª–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ:"
    )
    
    await query.edit_message_text(
        message_text, 
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    context.user_data['setup_step'] = 'balance'
    
    return WAITING_BALANCE_INPUT

async def back_to_currency(query, context):
    """–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≤–∏–±–æ—Ä—É –≤–∞–ª—é—Ç–∏"""
    return await show_currency_selection(query, context)

async def show_monthly_budget_input(query, context):
    """–ü–æ–∫–∞–∑—É—î —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –º—ñ—Å—è—á–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç—É"""
    keyboard = [[InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="budget")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message_text = (
        "üìù *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º—ñ—Å—è—á–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç—É*\n\n"
        "–í–∫–∞–∂—ñ—Ç—å —Å—É–º—É –≤–∞—à–æ–≥–æ –º—ñ—Å—è—á–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 15000).\n"
        "–¶–µ –¥–æ–ø–æ–º–æ–∂–µ –Ω–∞–º –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –≤–∞—à—ñ –≤–∏—Ç—Ä–∞—Ç–∏ —Ç–∞ –Ω–∞–¥–∞–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å–Ω—ñ –ø–æ—Ä–∞–¥–∏.\n\n"
        "–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É –≤ —á–∏—Å–ª–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ:"
    )
    
    message = await query.edit_message_text(
        message_text, 
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    context.user_data['waiting_for'] = 'monthly_budget'
    context.user_data['message_id'] = message.message_id
    
    return WAITING_BUDGET_INPUT

async def show_categories_setup(query, context):
    """–ü–æ–∫–∞–∑—É—î —Ñ–æ—Ä–º—É –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –≤–∏—Ç—Ä–∞—Ç —ñ –¥–æ—Ö–æ–¥—ñ–≤"""
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    user_id = query.from_user.id
    user = get_or_create_user(user_id)
    
    categories = get_user_categories(user.id)
    expense_categories = [c for c in categories if c.type == TransactionType.EXPENSE]
    income_categories = [c for c in categories if c.type == TransactionType.INCOME]
    
    # –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π, —è–∫—â–æ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —ó—Ö –Ω–µ–º–∞—î
    standard_expense_categories = [
        "–ü—Ä–æ–¥—É–∫—Ç–∏", "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ñ–∏—Ç–ª–æ", "–ö–æ–º—É–Ω–∞–ª—å–Ω—ñ –ø–æ—Å–ª—É–≥–∏", 
        "–†–æ–∑–≤–∞–≥–∏", "–û–¥—è–≥", "–ó–¥–æ—Ä–æ–≤'—è", "–û—Å–≤—ñ—Ç–∞", "–¢–µ—Ö–Ω—ñ–∫–∞"
    ]
    
    standard_income_categories = [
        "–ó–∞—Ä–ø–ª–∞—Ç–∞", "–§—Ä—ñ–ª–∞–Ω—Å", "–ü–æ–¥–∞—Ä—É–Ω–∫–∏", "–Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—ó", "–ü—Ä–æ–¥–∞–∂"
    ]
    
    # –î–æ–¥–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    with Session() as session:
        if not expense_categories:
            for name in standard_expense_categories:
                category = Category(
                    user_id=user.id,
                    name=name,
                    type=TransactionType.EXPENSE,
                    emoji="üì¶" # –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                )
                session.add(category)
            
        if not income_categories:
            for name in standard_income_categories:
                category = Category(
                    user_id=user.id,
                    name=name,
                    type=TransactionType.INCOME,
                    emoji="üí∞" # –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                )
                session.add(category)
            
        session.commit()
    
    # –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö
    categories = get_user_categories(user.id)
    expense_categories = [c for c in categories if c.type == TransactionType.EXPENSE]
    income_categories = [c for c in categories if c.type == TransactionType.INCOME]
    
    # –§–æ—Ä–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –∫–Ω–æ–ø–∫–∏
    expense_list = "\n".join([f"‚Ä¢ {c.name}" for c in expense_categories[:5]])
    income_list = "\n".join([f"‚Ä¢ {c.name}" for c in income_categories[:5]])
    
    keyboard = [
        [
            InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤–∏—Ç—Ä–∞—Ç", callback_data="edit_expense_categories")
        ],
        [
            InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–æ—Ö–æ–¥—ñ–≤", callback_data="edit_income_categories")
        ],
        [
            InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥ –¥–æ –±—é–¥–∂–µ—Ç—É", callback_data="budget"),
            InlineKeyboardButton("üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="back_to_main")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message_text = (
        "üè∑Ô∏è *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π*\n\n"
        "*–í–∞—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤–∏—Ç—Ä–∞—Ç:*\n"
        f"{expense_list}\n"
        f"...—Ç–∞ —â–µ {len(expense_categories) - 5 if len(expense_categories) > 5 else 0} —ñ–Ω—à–∏—Ö\n\n"
        "*–í–∞—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–æ—Ö–æ–¥—ñ–≤:*\n"
        f"{income_list}\n"
        f"...—Ç–∞ —â–µ {len(income_categories) - 5 if len(income_categories) > 5 else 0} —ñ–Ω—à–∏—Ö\n\n"
        "–ú–∏ –≤–∂–µ —Å—Ç–≤–æ—Ä–∏–ª–∏ –¥–ª—è –≤–∞—Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –Ω–∞–±—ñ—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ–π. "
        "–í–∏ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ó—Ö –∞–±–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ."
    )
    
    await query.edit_message_text(
        message_text, 
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    return ConversationHandler.END

async def process_initial_balance(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–æ–≥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å—É —ñ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"""
    try:
        balance = float(update.message.text.replace(',', '.'))
        user_id = update.effective_user.id
        
        with Session() as session:
            user = session.query(User).filter(User.telegram_id == user_id).first()
            user.initial_balance = balance
            
            # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ, —â–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            user.setup_step = 'completed'
            user.is_setup_completed = True
            
            session.commit()
            
            # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é
            transaction = Transaction(
                user_id=user.id,
                amount=balance,
                type=TransactionType.INCOME,
                description="–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å",
                transaction_date=datetime.utcnow()
            )
            session.add(transaction)
            session.commit()
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –≤–∞–ª—é—Ç—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        currency_code = user.currency
        currency_symbols = {
            "UAH": "‚Ç¥",
            "USD": "$",
            "EUR": "‚Ç¨",
            "GBP": "¬£"
        }
        currency_symbol = currency_symbols.get(currency_code, currency_code)
        
        # –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        keyboard = [
            [
                InlineKeyboardButton("üí∞ –ú—ñ–π –±—é–¥–∂–µ—Ç", callback_data="budget"),
                InlineKeyboardButton("‚ûï –î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é", callback_data="add_transaction")
            ],
            [
                InlineKeyboardButton("üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞", callback_data="reports"),
                InlineKeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", callback_data="settings")
            ],
            [
                InlineKeyboardButton("‚ùì –î–æ–ø–æ–º–æ–≥–∞", callback_data="help")
            ]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        message_text = (
            "üéâ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!*\n\n"
            f"‚úÖ –í–∞–ª—é—Ç–∞: {currency_code} ({currency_symbol})\n"
            f"‚úÖ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å: {balance} {currency_symbol}\n\n"
            "–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è —É—Å—ñ–º–∞ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏ –±–æ—Ç–∞ FinAssist.\n\n"
            "*–©–æ —Ä–æ–±–∏—Ç–∏ –¥–∞–ª—ñ:*\n"
            "‚Ä¢ –î–æ–¥–∞–π—Ç–µ –≤–∞—à—ñ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –¥–æ—Ö–æ–¥–∏ —ñ –≤–∏—Ç—Ä–∞—Ç–∏\n"
            "‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –≤ —Ä–æ–∑–¥—ñ–ª—ñ '–ú—ñ–π –±—é–¥–∂–µ—Ç'\n"
            "‚Ä¢ –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤ —Ä–æ–∑–¥—ñ–ª—ñ '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è'\n\n"
            "–î—è–∫—É—î–º–æ, —â–æ –æ–±—Ä–∞–ª–∏ –Ω–∞—à–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–Ω—Å–∞–º–∏! üíº"
        )
        
        await update.message.reply_text(
            message_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
        
        return ConversationHandler.END
        
    except ValueError:
        await update.message.reply_text(
            "‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 5000)."
        )
    
    return WAITING_BALANCE_INPUT

async def process_monthly_budget(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–æ–≥–æ –º—ñ—Å—è—á–Ω–æ–≥–æ –±—é–¥–∂–µ—Ç—É"""
    try:
        budget = float(update.message.text.replace(',', '.'))
        user_id = update.effective_user.id
        
        with Session() as session:
            user = session.query(User).filter(User.telegram_id == user_id).first()
            user.monthly_budget = budget
            session.commit()
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
        
        # –û—Ç—Ä–∏–º—É—î–º–æ —ñ—Å–Ω—É—é—á—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        user = get_or_create_user(user_id)
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        await setup_default_categories(user_id)
        
        # –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        await update.message.reply_text(
            "üöÄ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ - –ö—Ä–æ–∫ 3 –∑ 3*\n\n"
            f"‚úÖ –ú—ñ—Å—è—á–Ω–∏–π –±—é–¥–∂–µ—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {budget} –≥—Ä–Ω\n\n"
            "üè∑Ô∏è *–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤–∏—Ç—Ä–∞—Ç —Ç–∞ –¥–æ—Ö–æ–¥—ñ–≤*\n\n"
            "–ú–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–∏–ª–∏ –¥–ª—è –≤–∞—Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –Ω–∞–±—ñ—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –¥–ª—è –≤–∏—Ç—Ä–∞—Ç —Ç–∞ –¥–æ—Ö–æ–¥—ñ–≤.\n"
            "–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —ó—Ö –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ –≤ —Ä–æ–∑–¥—ñ–ª—ñ '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è' > '–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó'.\n\n"
            "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É '–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è' –¥–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏ –∑ –±–æ—Ç–æ–º.",
            parse_mode='Markdown',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", callback_data="complete_setup")]
            ])
        )
        
        context.user_data['setup_step'] = 'categories'
        return SETUP_COMPLETE
        
    except ValueError:
        await update.message.reply_text(
            "‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 15000)."
        )
    
    return WAITING_BUDGET_INPUT

async def start_initial_setup(query, context):
    """–ü–æ—á–∏–Ω–∞—î –ø—Ä–æ—Ü–µ—Å –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞"""
    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    context.user_data['setup_step'] = 'balance'
    
    # –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å—É
    keyboard = [[InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="back_to_main")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message_text = (
        "üöÄ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ - –ö—Ä–æ–∫ 1 –∑ 3*\n\n"
        "üí∞ *–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å*\n\n"
        "–í–∫–∞–∂—ñ—Ç—å —Å—É–º—É –∫–æ—à—Ç—ñ–≤, —è–∫—É –≤–∏ –º–∞—î—Ç–µ –∑–∞—Ä–∞–∑ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 5000).\n"
        "–¶–µ –¥–æ–ø–æ–º–æ–∂–µ –Ω–∞–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –≤–∞—à—ñ —Ñ—ñ–Ω–∞–Ω—Å–∏.\n\n"
        "–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É –≤ —á–∏—Å–ª–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ:"
    )
    
    message = await query.edit_message_text(
        message_text, 
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    context.user_data['message_id'] = message.message_id
    
    return WAITING_BALANCE_INPUT

async def complete_initial_setup(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–≤–µ—Ä—à—É—î –ø—Ä–æ—Ü–µ—Å –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞"""
    user_id = update.effective_user.id
    
    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ, —â–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
    with Session() as session:
        user = session.query(User).filter(User.telegram_id == user_id).first()
        user.is_setup_completed = True
        session.commit()
    
    keyboard = [
        [
            InlineKeyboardButton("üí∞ –ú—ñ–π –±—é–¥–∂–µ—Ç", callback_data="budget"),
            InlineKeyboardButton("‚ûï –î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é", callback_data="add_transaction")
        ],
        [
            InlineKeyboardButton("üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞", callback_data="reports"),
            InlineKeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", callback_data="settings")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üéâ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!*\n\n"
        "–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è —É—Å—ñ–º–∞ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏ –±–æ—Ç–∞ FinAssist.\n\n"
        "–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –ø–æ—á–∞—Ç–∏ –∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∞—à–∏—Ö –ø–µ—Ä—à–∏—Ö —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, "
        "—â–æ–± –º–∏ –º–æ–≥–ª–∏ –Ω–∞–¥–∞—Ç–∏ –≤–∞–º –∫–æ—Ä–∏—Å–Ω—É –∞–Ω–∞–ª—ñ—Ç–∏–∫—É —Ç–∞ –ø–æ—Ä–∞–¥–∏.\n\n"
        "*–©–æ —Ä–æ–±–∏—Ç–∏ –¥–∞–ª—ñ:*\n"
        "‚Ä¢ –î–æ–¥–∞–π—Ç–µ –≤–∞—à—ñ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –¥–æ—Ö–æ–¥–∏ —ñ –≤–∏—Ç—Ä–∞—Ç–∏\n"
        "‚Ä¢ –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –±–∞–Ω–∫—ñ–≤—Å—å–∫—É –≤–∏–ø–∏—Å–∫—É –∞–±–æ —Ñ–æ—Ç–æ —á–µ–∫—ñ–≤\n"
        "‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ –¥–Ω—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è\n\n"
        "–î—è–∫—É—î–º–æ, —â–æ –æ–±—Ä–∞–ª–∏ –Ω–∞—à–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–Ω—Å–∞–º–∏! üíº",
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    return ConversationHandler.END

async def complete_setup(query, context):
    """–ó–∞–≤–µ—Ä—à—É—î –ø—Ä–æ—Ü–µ—Å –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞"""
    user_id = query.from_user.id
    
    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ, —â–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
    with Session() as session:
        user = session.query(User).filter(User.telegram_id == user_id).first()
        user.is_setup_completed = True
        user.setup_step = 'completed'
        session.commit()
    
    keyboard = [
        [
            InlineKeyboardButton("üí∞ –ú—ñ–π –±—é–¥–∂–µ—Ç", callback_data="budget"),
            InlineKeyboardButton("‚ûï –î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é", callback_data="add_transaction")
        ],
        [
            InlineKeyboardButton("üìä –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞", callback_data="reports"),
            InlineKeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", callback_data="settings")
        ],
        [
            InlineKeyboardButton("‚ùì –î–æ–ø–æ–º–æ–≥–∞", callback_data="help")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "üéâ *–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!*\n\n"
        "–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è —É—Å—ñ–º–∞ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏ –±–æ—Ç–∞ FinAssist.\n\n"
        "–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –ø–æ—á–∞—Ç–∏ –∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∞—à–∏—Ö –ø–µ—Ä—à–∏—Ö —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, "
        "—â–æ–± –º–∏ –º–æ–≥–ª–∏ –Ω–∞–¥–∞—Ç–∏ –≤–∞–º –∫–æ—Ä–∏—Å–Ω—É –∞–Ω–∞–ª—ñ—Ç–∏–∫—É —Ç–∞ –ø–æ—Ä–∞–¥–∏.\n\n"
        "*–©–æ —Ä–æ–±–∏—Ç–∏ –¥–∞–ª—ñ:*\n"
        "‚Ä¢ –î–æ–¥–∞–π—Ç–µ –≤–∞—à—ñ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –¥–æ—Ö–æ–¥–∏ —ñ –≤–∏—Ç—Ä–∞—Ç–∏\n"
        "‚Ä¢ –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –±–∞–Ω–∫—ñ–≤—Å—å–∫—É –≤–∏–ø–∏—Å–∫—É –∞–±–æ —Ñ–æ—Ç–æ —á–µ–∫—ñ–≤\n"
        "‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ –¥–Ω—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è\n\n"
        "–î—è–∫—É—î–º–æ, —â–æ –æ–±—Ä–∞–ª–∏ –Ω–∞—à–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–Ω—Å–∞–º–∏! üíº",
        parse_mode='Markdown',
        reply_markup=reply_markup
    )
    
    return ConversationHandler.END

async def setup_default_categories(user_id):
    """–°—Ç–≤–æ—Ä—é—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤–∏—Ç—Ä–∞—Ç —Ç–∞ –¥–æ—Ö–æ–¥—ñ–≤ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
    user = get_or_create_user(user_id)
    
    categories = get_user_categories(user.id)
    expense_categories = [c for c in categories if c.type == TransactionType.EXPENSE]
    income_categories = [c for c in categories if c.type == TransactionType.INCOME]
    
    # –§–æ—Ä–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
    standard_expense_categories = [
        ("–ü—Ä–æ–¥—É–∫—Ç–∏", "ü•ó"),
        ("–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "üöå"),
        ("–ñ–∏—Ç–ª–æ", "üè†"),
        ("–ö–æ–º—É–Ω–∞–ª—å–Ω—ñ –ø–æ—Å–ª—É–≥–∏", "üí°"),
        ("–†–æ–∑–≤–∞–≥–∏", "üé≠"),
        ("–û–¥—è–≥", "üëö"),
        ("–ó–¥–æ—Ä–æ–≤'—è", "üè•"),
        ("–û—Å–≤—ñ—Ç–∞", "üìö"),
        ("–¢–µ—Ö–Ω—ñ–∫–∞", "üì±")
    ]
    
    standard_income_categories = [
        ("–ó–∞—Ä–ø–ª–∞—Ç–∞", "üí∞"),
        ("–§—Ä—ñ–ª–∞–Ω—Å", "üíª"),
        ("–ü–æ–¥–∞—Ä—É–Ω–∫–∏", "üéÅ"),
        ("–Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—ó", "üìà"),
        ("–ü—Ä–æ–¥–∞–∂", "üè∑Ô∏è")
    ]
    
    # –î–æ–¥–∞—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    with Session() as session:
        if not expense_categories:
            for name, emoji in standard_expense_categories:
                category = Category(
                    user_id=user.id,
                    name=name,
                    type=TransactionType.EXPENSE,
                    emoji=emoji
                )
                session.add(category)
            
        if not income_categories:
            for name, emoji in standard_income_categories:
                category = Category(
                    user_id=user.id,
                    name=name,
                    type=TransactionType.INCOME,
                    emoji=emoji
                )
                session.add(category)
            
        session.commit()
