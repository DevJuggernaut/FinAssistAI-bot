#!/bin/bash

echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ Python 3.13.4"
echo "========================================"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π Python 3.13
if ! command -v python3.13 &> /dev/null; then
    echo "‚ùå Python 3.13 –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π"
    echo "üí° –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Python 3.13:"
    echo "   brew install python@3.13  # macOS"
    echo "   –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ pyenv"
    echo ""
    echo "‚úÖ –ù–∞ Render –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ Python 3.13.4 –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
    exit 0
fi

echo "‚úÖ Python 3.13 –∑–Ω–∞–π–¥–µ–Ω–æ"
python3.13 --version

# –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–µ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
echo ""
echo "üîß –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞..."
python3.13 -m venv test_env_313
source test_env_313/bin/activate

# –¢–µ—Å—Ç—É—î–º–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
echo ""
echo "üì¶ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."

pip install --upgrade pip > /dev/null 2>&1

# –¢–µ—Å—Ç—É—î–º–æ –∫–æ–∂–Ω—É –∫—Ä–∏—Ç–∏—á–Ω—É –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å
critical_deps=(
    "python-telegram-bot==21.9"
    "python-dotenv==1.0.1"
    "SQLAlchemy==2.0.36"
    "psycopg2-binary==2.9.10"
    "openai==1.58.1"
    "numpy==2.2.1"
)

failed_deps=()

for dep in "${critical_deps[@]}"; do
    echo -n "  –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è $dep... "
    if pip install "$dep" > /dev/null 2>&1; then
        echo "‚úÖ"
    else
        echo "‚ùå"
        failed_deps+=("$dep")
    fi
done

echo ""

if [ ${#failed_deps[@]} -eq 0 ]; then
    echo "üéâ –í—Å—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —É—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –∑ Python 3.13!"
    
    # –¢–µ—Å—Ç—É—î–º–æ —ñ–º–ø–æ—Ä—Ç
    echo ""
    echo "üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—É –º–æ–¥—É–ª—ñ–≤..."
    python3.13 -c "
import telegram
import sqlalchemy
import openai
import numpy
import pandas
print('‚úÖ –í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ –º–æ–¥—É–ª—ñ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ')
    " 2>/dev/null && echo "‚úÖ –Ü–º–ø–æ—Ä—Ç —É—Å–ø—ñ—à–Ω–∏–π" || echo "‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É"
    
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:"
    for dep in "${failed_deps[@]}"; do
        echo "  - $dep"
    done
fi

# –û—á–∏—â–µ–Ω–Ω—è
deactivate
rm -rf test_env_313

echo ""
echo "üìù –ü—Ä–∏–º—ñ—Ç–∫–∞: –ù–∞ Render –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –±—É–¥—É—Ç—å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
