#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ–µ–∫—Ç—É FinAssistAI

echo "üöÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è FinAssistAI Telegram –±–æ—Ç–∞..."

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ Python
if ! command -v python3 &>/dev/null; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: Python 3 –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Python 3."
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä—Å—ñ—ó Python
PYTHON_VERSION=$(python3 -c 'import sys; v=sys.version_info[:2]; print(f"{v[0]}.{v[1]}")')
MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)
if [ "$MAJOR" -lt 3 ] || ([ "$MAJOR" -eq 3 ] && [ "$MINOR" -lt 8 ]); then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ü–æ—Ç—Ä—ñ–±–µ–Ω Python 3.8 –∞–±–æ –≤–∏—â–µ. –ù–∞—Ä–∞–∑—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è $PYTHON_VERSION"
    exit 1
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
echo "üîß –°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ..."
if [ -d "venv" ]; then
    echo "‚ö†Ô∏è –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –≤–∂–µ —ñ—Å–Ω—É—î. –í–∏–¥–∞–ª—è—î–º–æ —Ç–∞ —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–µ..."
    rm -rf venv
fi

python3 -m venv venv
if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞."
    exit 1
fi

# –ê–∫—Ç–∏–≤–∞—Ü—ñ—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
source venv/bin/activate
if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞."
    exit 1
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ..."
pip install --upgrade pip
pip install -r requirements.txt
if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π."
    exit 1
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó .env, —è–∫—â–æ –π–æ–≥–æ –Ω–µ —ñ—Å–Ω—É—î
if [ ! -f ".env" ]; then
    echo "üìù –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª .env..."
    echo "TELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞" > .env
    echo "OPENAI_API_KEY=–≤–∞—à_–∫–ª—é—á_openai_api" >> .env
    echo "DATABASE_URL=sqlite:///data/finassist.db" >> .env
    echo "DEBUG=true" >> .env
    echo "‚ö†Ô∏è –°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª .env. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ –π–æ–≥–æ —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –≤–∞—à—ñ —Ç–æ–∫–µ–Ω–∏."
else
    echo "‚úÖ –§–∞–π–ª .env –≤–∂–µ —ñ—Å–Ω—É—î."
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π
echo "üìÅ –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó..."
mkdir -p data
mkdir -p uploads/receipts
mkdir -p uploads/statements
mkdir -p reports
mkdir -p logs

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
echo "üóÑÔ∏è –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö..."
python -c "from database.models import init_db; init_db()"
if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö."
    exit 1
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
echo "üìä –°—Ç–≤–æ—Ä—é—î–º–æ –±–∞–∑–æ–≤—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó..."
python -c "from utils.database_setup import create_default_categories; create_default_categories()"
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –±–∞–∑–æ–≤–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π."
fi

# –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è
echo ""
echo "‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
echo ""
echo "üìå –©–æ –¥–∞–ª—ñ:"
echo "1. –í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ —Ñ–∞–π–ª .env —Ç–∞ –¥–æ–¥–∞–π—Ç–µ –≤–∞—à—ñ —Ç–æ–∫–µ–Ω–∏"
echo "2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ—é: python bot.py"
echo "3. –ê–±–æ –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Ç–µ—Å—Ç–∏: ./run_tests.sh"
echo ""
echo "–î—è–∫—É—î–º–æ –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è FinAssistAI! ü§ñüí∞"

# –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
deactivate
